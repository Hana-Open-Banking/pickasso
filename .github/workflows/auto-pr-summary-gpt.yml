name: Auto PR Summary (GPT-based)

on:
  pull_request:
    types: [opened]

jobs:
  summarize-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install openai

      - name: Debug base branch
        run: |
          echo "ðŸ“Œ ê¸°ì¤€ ë¸Œëžœì¹˜ (base_ref): ${{ github.base_ref }}"

      - name: Generate natural language summary using GPT
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # ê¸°ì¤€ ë¸Œëžœì¹˜ ìžë™ ê°ì§€ í›„ diff ê³„ì‚°
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > changes.diff

          python3 <<EOF
          import openai
          import os

          openai.api_key = os.getenv("OPENAI_API_KEY")

          with open("changes.diff", "r") as f:
              diff_text = f.read()

          prompt = f"""ë‹¤ìŒì€ git diff ê²°ê³¼ìž…ë‹ˆë‹¤. ì´ ë³€ê²½ì‚¬í•­ì„ í•œêµ­ì–´ë¡œ ê°„ê²°í•˜ê³  ìžì—°ìŠ¤ëŸ½ê²Œ ìš”ì•½í•´ì£¼ì„¸ìš”. 
          ë°˜ë“œì‹œ Pull Request ë³¸ë¬¸ìœ¼ë¡œ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡ ìž‘ì„±í•´ ì£¼ì„¸ìš”:

          {diff_text}
          """

          try:
              response = openai.ChatCompletion.create(
                  model="gpt-4",
                  messages=[
                      {"role": "system", "content": "ë‹¹ì‹ ì€ í”„ë¡œê·¸ëž˜ë° ë³€ê²½ì‚¬í•­ì„ ì •ë¦¬í•˜ëŠ” ì „ë¬¸ê°€ìž…ë‹ˆë‹¤."},
                      {"role": "user", "content": prompt}
                  ],
                  max_tokens=800
              )

              summary = response["choices"][0]["message"]["content"]

              with open("pr_body.txt", "w") as out:
                  out.write("## ë³€ê²½ ìš”ì•½ (GPT ê¸°ë°˜)\n\n")
                  out.write(summary.strip())

          except Exception as e:
              with open("pr_body.txt", "w") as out:
                  out.write("GPT ìš”ì•½ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + str(e))
          EOF

      - name: Install GitHub CLI
        run: |
          sudo apt update && sudo apt install gh -y

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Update PR Description
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          gh pr edit "$PR_NUMBER" --repo "$REPO" --body "$(cat pr_body.txt)"
